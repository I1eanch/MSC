# Интеграция Dashboard Backend с внешними сервисами

## Обзор

Dashboard Backend теперь может работать в двух режимах:

1. **Локальный режим** (порт 3000) - использует только JSON файлы
2. **Интегрированный режим** (порт 3001) - подключается к внешним сервисам из Пакетов 1-2

## Быстрый старт

### Локальный режим (без внешних сервисов)

```bash
npm install
npm start
```

Сервер запустится на `http://localhost:3000`

### Интегрированный режим (с внешними сервисами)

```bash
npm install
cp .env.example .env
# Отредактируйте .env для включения интеграций
npm run start:integrated
```

Сервер запустится на `http://localhost:3001`

## Конфигурация

Создайте файл `.env`:

```env
# Порт сервера
PORT=3001

# Включить/выключить сервисы
ENABLE_HABITS_INTEGRATION=true      # Habits Backend (NestJS)
ENABLE_TRAINING_INTEGRATION=true    # Training Backend (Flask)
ENABLE_VIDEO_INTEGRATION=false      # Видео инфраструктура

# URL внешних сервисов
HABITS_API_URL=http://localhost:3000
TRAINING_API_URL=http://localhost:5000
VIDEO_API_URL=http://localhost:4000

# Режим fallback (использовать локальные данные при недоступности сервисов)
FALLBACK_MODE=true
```

## Интегрированные сервисы

### 1. Habits Backend (NestJS + TypeORM)

**Что интегрировано:**
- Получение привычек пользователя
- Статистика по привычкам
- Отметка выполнения привычек
- Streak (серии выполнений)

**Требуется:**
- JWT токен в заголовке `Authorization: Bearer <token>`
- User ID в заголовке `x-user-id: <user_id>`

**Пример:**
```bash
curl http://localhost:3001/api/dashboard/habits \
  -H "Authorization: Bearer eyJhbGc..." \
  -H "x-user-id: 123"
```

### 2. Training Backend (Flask + SQLAlchemy)

**Что интегрировано:**
- Текущий план тренировок
- История тренировок
- Прогресс за неделю
- Статистика выполнения

**Требуется:**
- User ID в заголовке `x-user-id: <user_id>`

**Пример:**
```bash
curl http://localhost:3001/api/dashboard/workouts/plan \
  -H "x-user-id: 123"
```

### 3. Video Infrastructure (В разработке)

Интеграция с видео сервисом планируется для добавления:
- Видео упражнений
- Метаданные видео
- Защищенные URL для просмотра

## API Endpoints

### Основные endpoints

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/dashboard` | Полная информация дашборда |
| GET | `/api/dashboard/summary` | Краткая сводка |
| GET | `/health` | Статус сервера и интеграций |

### Привычки (Habits)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/dashboard/habits` | Список привычек |
| POST | `/api/dashboard/habits/:id/toggle` | Отметить/снять отметку |
| POST | `/api/dashboard/habits/reset` | Сбросить все привычки |

### Тренировки (Training)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/dashboard/workouts` | Прогресс за неделю |
| GET | `/api/dashboard/workouts/plan` | Текущий план тренировок |
| GET | `/api/dashboard/workouts/history` | История тренировок |

## Режим Fallback

При включенном `FALLBACK_MODE=true`:

1. Dashboard пытается подключиться к внешнему сервису
2. Если сервис недоступен или возвращает ошибку:
   - Автоматически переключается на локальные JSON данные
   - Логирует ошибку
   - Продолжает обслуживать запрос
   - Помечает ответ как `source: "local"`

**Пример ответа при fallback:**
```json
{
  "success": true,
  "data": {
    "habits": {
      "checklist": [...],
      "source": "local"  // Данные из локального файла
    },
    "workouts": {
      "weeklyProgress": {...},
      "source": "training-api"  // Данные из внешнего API
    }
  }
}
```

## Проверка статуса интеграций

```bash
curl http://localhost:3001/health
```

Ответ покажет:
```json
{
  "status": "healthy",
  "integrations": {
    "habits": {
      "enabled": true,
      "url": "http://localhost:3000"
    },
    "training": {
      "enabled": true,
      "url": "http://localhost:5000"
    }
  },
  "fallbackMode": true
}
```

## Тестирование

```bash
# Запустить все тесты
npm test

# Тесты интеграции
npm test tests/integration.test.js
```

**Результаты:**
- ✅ 89 тестов пройдено
- ✅ 70% покрытие кода
- ✅ Все тесты работают без внешних сервисов

## Архитектура

```
┌─────────────────────────────┐
│   Dashboard Backend API     │
│       (Node.js/Express)     │
│         Port 3001           │
└──────┬──────────┬───────────┘
       │          │
   ┌───▼──┐   ┌──▼───┐
   │Habits│   │Train │
   │ API  │   │ API  │
   │:3000 │   │:5000 │
   └──────┘   └──────┘
       │          │
       └────┬─────┘
            │ При ошибке
       ┌────▼────┐
       │  Local  │
       │  JSON   │
       └─────────┘
```

## Файлы проекта

### Новые файлы интеграции

```
backend/
├── clients/                    # HTTP клиенты
│   ├── habitsClient.js        # Клиент для Habits API
│   └── trainingClient.js      # Клиент для Training API
│
├── config/
│   └── services.js            # Конфигурация сервисов
│
├── services/
│   ├── habitServiceIntegrated.js      # Интегрированные привычки
│   ├── workoutServiceIntegrated.js    # Интегрированные тренировки
│   └── dashboardServiceIntegrated.js  # Агрегация данных
│
├── routes/
│   └── dashboardIntegrated.js # Маршруты с интеграцией
│
├── tests/
│   └── integration.test.js    # Тесты интеграции
│
├── serverIntegrated.js        # Сервер с интеграциями
├── .env.example               # Пример конфигурации
│
├── INTEGRATION.md             # Подробное руководство
├── QUICKSTART.md              # Быстрый старт
├── PROJECT_SUMMARY.md         # Сводка проекта
└── ИНТЕГРАЦИЯ.md              # Этот файл
```

## Сценарии использования

### Сценарий 1: Разработка без внешних сервисов

```bash
npm run dev
# Порт 3000, только локальные данные
```

### Сценарий 2: Тестирование интеграции

```bash
# Терминал 1: Запустить Habits Backend
cd habits-backend
npm run start:dev

# Терминал 2: Запустить Training Backend
cd training-backend
python run.py

# Терминал 3: Запустить Dashboard
cd dashboard-backend
npm run dev:integrated
```

### Сценарий 3: Продакшен с интеграциями

```bash
export ENABLE_HABITS_INTEGRATION=true
export ENABLE_TRAINING_INTEGRATION=true
export HABITS_API_URL=https://habits.example.com
export TRAINING_API_URL=https://training.example.com
npm run start:integrated
```

## Отладка

### Проблема: Сервис не подключается

1. Проверьте, что сервис запущен:
   ```bash
   curl http://localhost:3000/health  # Habits
   curl http://localhost:5000/health  # Training
   ```

2. Проверьте `.env` файл

3. Посмотрите логи Dashboard для ошибок подключения

4. Убедитесь что `FALLBACK_MODE=true` для graceful degradation

### Проблема: Всегда используются локальные данные

1. Проверьте что `ENABLE_*_INTEGRATION=true` в `.env`
2. Проверьте URL сервисов
3. Проверьте JWT токен (для Habits)
4. Посмотрите поле `source` в ответе API

## Дополнительная документация

- [QUICKSTART.md](./QUICKSTART.md) - Быстрый старт на английском
- [INTEGRATION.md](./INTEGRATION.md) - Подробное руководство по интеграции
- [README_INTEGRATED.md](./README_INTEGRATED.md) - Полная документация
- [PROJECT_SUMMARY.md](./PROJECT_SUMMARY.md) - Сводка проекта

## Статус реализации

✅ Интеграция с Habits Backend (NestJS)  
✅ Интеграция с Training Backend (Flask)  
✅ Режим fallback при недоступности сервисов  
✅ Отслеживание источника данных  
✅ Конфигурация через переменные окружения  
✅ 89 тестов, 70% покрытие  
⏳ Интеграция с Video Infrastructure (планируется)  

---

**Версия:** 2.0.0  
**Дата обновления:** 2025-11-06  
**Статус:** Готово к использованию ✅
